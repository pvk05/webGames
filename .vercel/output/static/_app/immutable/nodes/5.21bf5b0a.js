import{s as _n,n as En}from"../chunks/scheduler.e108d1fd.js";import{S as In,i as Dn,g as pt,s as xn,r as Mn,h as ht,j as An,y as Nn,c as Gn,u as Cn,f as vt,a as jn,x as yt,v as Tn,d as Ln,t as Un,w as Rn}from"../chunks/index.a21d6cee.js";let kn=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");function $(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+e+(n.length?" "+n.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function Z(e){return!!e&&!!e[U]}function Y(e){var t;return!!e&&(function(n){if(!n||typeof n!="object")return!1;var r=Object.getPrototypeOf(n);if(r===null)return!0;var i=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return i===Object||typeof i=="function"&&Function.toString.call(i)===Kn}(e)||Array.isArray(e)||!!e[_t]||!!(!((t=e.constructor)===null||t===void 0)&&t[_t])||Be(e)||Je(e))}function re(e,t,n){n===void 0&&(n=!1),te(e)===0?(n?Object.keys:Ye)(e).forEach(function(r){n&&typeof r=="symbol"||t(r,e[r],e)}):e.forEach(function(r,i){return t(i,r,e)})}function te(e){var t=e[U];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:Be(e)?2:Je(e)?3:0}function je(e,t){return te(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function $n(e,t){return te(e)===2?e.get(t):e[t]}function jt(e,t,n){var r=te(e);r===2?e.set(t,n):r===3?e.add(n):e[t]=n}function Fn(e,t){return e===t?e!==0||1/e==1/t:e!=e&&t!=t}function Be(e){return Bn&&e instanceof Map}function Je(e){return Jn&&e instanceof Set}function q(e){return e.o||e.t}function Ke(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=Hn(e);delete t[U];for(var n=Ye(t),r=0;r<n.length;r++){var i=n[r],o=t[i];o.writable===!1&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(t[i]={configurable:!0,writable:!0,enumerable:o.enumerable,value:e[i]})}return Object.create(Object.getPrototypeOf(e),t)}function He(e,t){return t===void 0&&(t=!1),qe(e)||Z(e)||!Y(e)||(te(e)>1&&(e.set=e.add=e.clear=e.delete=Wn),Object.freeze(e),t&&re(e,function(n,r){return He(r,!0)},!0)),e}function Wn(){$(2)}function qe(e){return e==null||typeof e!="object"||Object.isFrozen(e)}function W(e){var t=qn[e];return t||$(18,e),t}function mt(){return ie}function De(e,t){t&&(W("Patches"),e.u=[],e.s=[],e.v=t)}function ve(e){Te(e),e.p.forEach(Vn),e.p=null}function Te(e){e===ie&&(ie=e.l)}function gt(e){return ie={p:[],l:ie,h:e,m:!0,_:0}}function Vn(e){var t=e[U];t.i===0||t.i===1?t.j():t.g=!0}function xe(e,t){t._=t.p.length;var n=t.p[0],r=e!==void 0&&e!==n;return t.h.O||W("ES5").S(t,e,r),r?(n[U].P&&(ve(t),$(4)),Y(e)&&(e=ye(t,e),t.l||me(t,e)),t.u&&W("Patches").M(n[U].t,e,t.u,t.s)):e=ye(t,n,[]),ve(t),t.u&&t.v(t.u,t.s),e!==Tt?e:void 0}function ye(e,t,n){if(qe(t))return t;var r=t[U];if(!r)return re(t,function(a,f){return bt(e,r,t,a,f,n)},!0),t;if(r.A!==e)return t;if(!r.P)return me(e,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var i=r.i===4||r.i===5?r.o=Ke(r.k):r.o,o=i,c=!1;r.i===3&&(o=new Set(i),i.clear(),c=!0),re(o,function(a,f){return bt(e,r,i,a,f,n,c)}),me(e,i,!1),n&&e.u&&W("Patches").N(r,n,e.u,e.s)}return r.o}function bt(e,t,n,r,i,o,c){if(Z(i)){var a=ye(e,i,o&&t&&t.i!==3&&!je(t.R,r)?o.concat(r):void 0);if(jt(n,r,a),!Z(a))return;e.m=!1}else c&&n.add(i);if(Y(i)&&!qe(i)){if(!e.h.D&&e._<1)return;ye(e,i),t&&t.A.l||me(e,i)}}function me(e,t,n){n===void 0&&(n=!1),!e.l&&e.h.D&&e.m&&He(t,n)}function Me(e,t){var n=e[U];return(n?q(n):e)[t]}function Pt(e,t){if(t in e)for(var n=Object.getPrototypeOf(e);n;){var r=Object.getOwnPropertyDescriptor(n,t);if(r)return r;n=Object.getPrototypeOf(n)}}function Le(e){e.P||(e.P=!0,e.l&&Le(e.l))}function Ae(e){e.o||(e.o=Ke(e.t))}function Ue(e,t,n){var r=Be(t)?W("MapSet").F(t,n):Je(t)?W("MapSet").T(t,n):e.O?function(i,o){var c=Array.isArray(i),a={i:c?1:0,A:o?o.A:mt(),P:!1,I:!1,R:{},l:o,t:i,k:null,o:null,j:null,C:!1},f=a,h=Re;c&&(f=[a],h=ne);var p=Proxy.revocable(f,h),y=p.revoke,w=p.proxy;return a.k=w,a.j=y,w}(t,n):W("ES5").J(t,n);return(n?n.A:mt()).p.push(r),r}function zn(e){return Z(e)||$(22,e),function t(n){if(!Y(n))return n;var r,i=n[U],o=te(n);if(i){if(!i.P&&(i.i<4||!W("ES5").K(i)))return i.t;i.I=!0,r=Ot(n,o),i.I=!1}else r=Ot(n,o);return re(r,function(c,a){i&&$n(i.t,c)===a||jt(r,c,t(a))}),o===3?new Set(r):r}(e)}function Ot(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return Ke(e)}var wt,ie,Xe=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",Bn=typeof Map<"u",Jn=typeof Set<"u",St=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",Tt=Xe?Symbol.for("immer-nothing"):((wt={})["immer-nothing"]=!0,wt),_t=Xe?Symbol.for("immer-draftable"):"__$immer_draftable",U=Xe?Symbol.for("immer-state"):"__$immer_state",Kn=""+Object.prototype.constructor,Ye=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,Hn=Object.getOwnPropertyDescriptors||function(e){var t={};return Ye(e).forEach(function(n){t[n]=Object.getOwnPropertyDescriptor(e,n)}),t},qn={},Re={get:function(e,t){if(t===U)return e;var n=q(e);if(!je(n,t))return function(i,o,c){var a,f=Pt(o,c);return f?"value"in f?f.value:(a=f.get)===null||a===void 0?void 0:a.call(i.k):void 0}(e,n,t);var r=n[t];return e.I||!Y(r)?r:r===Me(e.t,t)?(Ae(e),e.o[t]=Ue(e.A.h,r,e)):r},has:function(e,t){return t in q(e)},ownKeys:function(e){return Reflect.ownKeys(q(e))},set:function(e,t,n){var r=Pt(q(e),t);if(r!=null&&r.set)return r.set.call(e.k,n),!0;if(!e.P){var i=Me(q(e),t),o=i==null?void 0:i[U];if(o&&o.t===n)return e.o[t]=n,e.R[t]=!1,!0;if(Fn(n,i)&&(n!==void 0||je(e.t,t)))return!0;Ae(e),Le(e)}return e.o[t]===n&&(n!==void 0||t in e.o)||Number.isNaN(n)&&Number.isNaN(e.o[t])||(e.o[t]=n,e.R[t]=!0),!0},deleteProperty:function(e,t){return Me(e.t,t)!==void 0||t in e.t?(e.R[t]=!1,Ae(e),Le(e)):delete e.R[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var n=q(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r&&{writable:!0,configurable:e.i!==1||t!=="length",enumerable:r.enumerable,value:n[t]}},defineProperty:function(){$(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){$(12)}},ne={};re(Re,function(e,t){ne[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),ne.deleteProperty=function(e,t){return ne.set.call(this,e,t,void 0)},ne.set=function(e,t,n){return Re.set.call(this,e[0],t,n,e[0])};var Xn=function(){function e(n){var r=this;this.O=St,this.D=!0,this.produce=function(i,o,c){if(typeof i=="function"&&typeof o!="function"){var a=o;o=i;var f=r;return function(m){var S=this;m===void 0&&(m=a);for(var M=arguments.length,E=Array(M>1?M-1:0),A=1;A<M;A++)E[A-1]=arguments[A];return f.produce(m,function(z){var Q;return(Q=o).call.apply(Q,[S,z].concat(E))})}}var h;if(typeof o!="function"&&$(6),c!==void 0&&typeof c!="function"&&$(7),Y(i)){var p=gt(r),y=Ue(r,i,void 0),w=!0;try{h=o(y),w=!1}finally{w?ve(p):Te(p)}return typeof Promise<"u"&&h instanceof Promise?h.then(function(m){return De(p,c),xe(m,p)},function(m){throw ve(p),m}):(De(p,c),xe(h,p))}if(!i||typeof i!="object"){if((h=o(i))===void 0&&(h=i),h===Tt&&(h=void 0),r.D&&He(h,!0),c){var b=[],O=[];W("Patches").M(i,h,b,O),c(b,O)}return h}$(21,i)},this.produceWithPatches=function(i,o){if(typeof i=="function")return function(h){for(var p=arguments.length,y=Array(p>1?p-1:0),w=1;w<p;w++)y[w-1]=arguments[w];return r.produceWithPatches(h,function(b){return i.apply(void 0,[b].concat(y))})};var c,a,f=r.produce(i,o,function(h,p){c=h,a=p});return typeof Promise<"u"&&f instanceof Promise?f.then(function(h){return[h,c,a]}):[f,c,a]},typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze)}var t=e.prototype;return t.createDraft=function(n){Y(n)||$(8),Z(n)&&(n=zn(n));var r=gt(this),i=Ue(this,n,void 0);return i[U].C=!0,Te(r),i},t.finishDraft=function(n,r){var i=n&&n[U],o=i.A;return De(o,r),xe(void 0,o)},t.setAutoFreeze=function(n){this.D=n},t.setUseProxies=function(n){n&&!St&&$(20),this.O=n},t.applyPatches=function(n,r){var i;for(i=r.length-1;i>=0;i--){var o=r[i];if(o.path.length===0&&o.op==="replace"){n=o.value;break}}i>-1&&(r=r.slice(i+1));var c=W("Patches").$;return Z(n)?c(n,r):this.produce(n,function(a){return c(a,r)})},e}(),R=new Xn,Yn=R.produce;R.produceWithPatches.bind(R);R.setAutoFreeze.bind(R);R.setUseProxies.bind(R);R.applyPatches.bind(R);R.createDraft.bind(R);R.finishDraft.bind(R);const Qn=Yn;var Et=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Zn=Function.prototype,er=Zn.toString;er.call(Object);const Qe="MAKE_MOVE",be="GAME_EVENT",Ze="REDO",et="RESET",tt="SYNC",nt="UNDO",rt="UPDATE",it="PATCH",Lt="PLUGIN",ot="STRIP_TRANSIENTS",tr=(e,t,n,r)=>({type:Qe,payload:{type:e,args:t,playerID:n,credentials:r}}),pe=(e,t,n,r)=>({type:be,payload:{type:e,args:t,playerID:n,credentials:r}}),Ut=(e,t,n,r)=>({type:be,payload:{type:e,args:t,playerID:n,credentials:r},automatic:!0}),nr=e=>({type:tt,state:e.state,log:e.log,initialState:e.initialState,clientOnly:!0}),rr=(e,t,n,r)=>({type:it,prevStateID:e,stateID:t,patch:n,deltalog:r,clientOnly:!0}),ir=(e,t)=>({type:rt,state:e,deltalog:t,clientOnly:!0}),Rt=e=>({type:et,state:e,clientOnly:!0}),kt=(e,t)=>({type:nt,payload:{type:null,args:null,playerID:e,credentials:t}}),$t=(e,t)=>({type:Ze,payload:{type:null,args:null,playerID:e,credentials:t}}),or=(e,t,n,r)=>({type:Lt,payload:{type:e,args:t,playerID:n,credentials:r}}),Ft=()=>({type:ot});var sr=Object.freeze({makeMove:tr,gameEvent:pe,automaticGameEvent:Ut,sync:nr,patch:rr,update:ir,reset:Rt,undo:kt,redo:$t,plugin:or,stripTransients:Ft});const ke="INVALID_MOVE",ar={name:"plugin-immer",fnWrap:e=>(t,n,...r)=>{let i=!1;const o=Qn(t,c=>{const a=e(c,n,...r);if(a===ke){i=!0;return}return a});return i?ke:o}};class ur{constructor(t){const n=cr();this.c=1,this.s0=n(" "),this.s1=n(" "),this.s2=n(" "),this.s0-=n(t),this.s0<0&&(this.s0+=1),this.s1-=n(t),this.s1<0&&(this.s1+=1),this.s2-=n(t),this.s2<0&&(this.s2+=1)}next(){const t=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=t-(this.c=Math.trunc(t))}}function cr(){let e=4022871197;return function(n){const r=n.toString();for(let i=0;i<r.length;i++){e+=r.charCodeAt(i);let o=.02519603282416938*e;e=o>>>0,o-=e,o*=e,e=o>>>0,o-=e,e+=o*4294967296}return(e>>>0)*23283064365386963e-26}}function It(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function lr(e,t){const n=new ur(e),r=n.next.bind(n);return t&&It(t,n),r.state=()=>It(n,{}),r}class Dt{constructor(t){this.state=t||{seed:"0"},this.used=!1}static seed(){return Date.now().toString(36).slice(-10)}isUsed(){return this.used}getState(){return this.state}_random(){this.used=!0;const t=this.state,n=t.prngstate?"":t.seed,r=lr(n,t.prngstate),i=r();return this.state={...t,prngstate:r.state()},i}api(){const t=this._random.bind(this),n={D4:4,D6:6,D8:8,D10:10,D12:12,D20:20},r={};for(const o in n){const c=n[o];r[o]=a=>a===void 0?Math.floor(t()*c)+1:[...new Array(a).keys()].map(()=>Math.floor(t()*c)+1)}function i(o=6,c){return c===void 0?Math.floor(t()*o)+1:[...new Array(c).keys()].map(()=>Math.floor(t()*o)+1)}return{...r,Die:i,Number:()=>t(),Shuffle:o=>{const c=o.slice(0);let a=o.length,f=0;const h=new Array(a);for(;a;){const p=Math.trunc(a*t());h[f++]=c[p],c[p]=c[--a]}return h},_obj:this}}}const fr={name:"random",noClient:({api:e})=>e._obj.isUsed(),flush:({api:e})=>e._obj.getState(),api:({data:e})=>new Dt(e).api(),setup:({game:e})=>{let{seed:t}=e;return t===void 0&&(t=Dt.seed()),{seed:t}},playerView:()=>{}};class dr{constructor(t,n){this.flow=t,this.playerID=n,this.dispatch=[]}api(t){const n={_obj:this},{phase:r,turn:i}=t;for(const o of this.flow.eventNames)n[o]=(...c)=>{this.dispatch.push({key:o,args:c,phase:r,turn:i})};return n}isUsed(){return this.dispatch.length>0}update(t){for(let n=0;n<this.dispatch.length;n++){const r=this.dispatch[n];if(r.key==="endTurn"&&r.turn!==t.ctx.turn||(r.key==="endPhase"||r.key==="setPhase")&&r.phase!==t.ctx.phase)continue;const i=Ut(r.key,r.args,this.playerID);t={...t,...this.flow.processEvent(t,i)}}return t}}const Wt={name:"events",noClient:({api:e})=>e._obj.isUsed(),dangerouslyFlushRawState:({state:e,api:t})=>t._obj.update(e),api:({game:e,playerID:t,ctx:n})=>new dr(e.flow,t).api(n)},pr={name:"log",flush:()=>({}),api:({data:e})=>({setMetadata:t=>{e.metadata=t}}),setup:()=>({})},hr={name:"plugin-serializable",fnWrap:e=>(t,n,...r)=>e(t,n,...r)},Vt=[ar,fr,pr,hr],ae=[...Vt,Wt],vr=(e,t,n)=>(n.game.plugins.filter(r=>r.action!==void 0).filter(r=>r.name===t.payload.type).forEach(r=>{const i=r.name,o=e.plugins[i]||{data:{}},c=r.action(o.data,t.payload);e={...e,plugins:{...e.plugins,[i]:{...o,data:c}}}}),e),ee=e=>{const t={...e.ctx},n=e.plugins||{};return Object.entries(n).forEach(([r,{api:i}])=>{t[r]=i}),t},zt=(e,t)=>{const n=(r,{fnWrap:i})=>i(r);return[...ae,...t].filter(r=>r.fnWrap!==void 0).reduce(n,e)},yr=(e,t)=>([...ae,...t.game.plugins].filter(n=>n.setup!==void 0).forEach(n=>{const r=n.name,i=n.setup({G:e.G,ctx:e.ctx,game:t.game});e={...e,plugins:{...e.plugins,[r]:{data:i}}}}),e),$e=(e,t)=>([...ae,...t.game.plugins].filter(n=>n.api!==void 0).forEach(n=>{const r=n.name,i=e.plugins[r]||{data:{}},o=n.api({G:e.G,ctx:e.ctx,data:i.data,game:t.game,playerID:t.playerID});e={...e,plugins:{...e.plugins,[r]:{...i,api:o}}}}),e),he=(e,t)=>([...Vt,...t.game.plugins,Wt].reverse().forEach(n=>{const r=n.name,i=e.plugins[r]||{data:{}};if(n.flush){const o=n.flush({G:e.G,ctx:e.ctx,game:t.game,api:i.api,data:i.data});e={...e,plugins:{...e.plugins,[n.name]:{data:o}}}}else if(n.dangerouslyFlushRawState){e=n.dangerouslyFlushRawState({state:e,game:t.game,api:i.api,data:i.data});const o=e.plugins[r].data;e={...e,plugins:{...e.plugins,[n.name]:{data:o}}}}}),e),mr=(e,t)=>[...ae,...t.game.plugins].filter(n=>n.noClient!==void 0).map(n=>{const r=n.name,i=e.plugins[r];return i?n.noClient({G:e.G,ctx:e.ctx,game:t.game,api:i.api,data:i.data}):!1}).some(n=>n===!0),gr=({G:e,ctx:t,plugins:n={}},{game:r,playerID:i})=>([...ae,...r.plugins].forEach(({name:o,playerView:c})=>{if(!c)return;const{data:a}=n[o]||{data:{}},f=c({G:e,ctx:t,game:r,data:a,playerID:i});n={...n,[o]:{data:f}}}),n),br=(...e)=>console.error(...e);function x(e){br("ERROR:",e)}function Pr(e,t,n){return{...e,ctx:Pe(e.ctx,n)}}function Pe(e,t){let{_prevActivePlayers:n}=e,r={},i=null,o={};if(Array.isArray(t)){const a={};t.forEach(f=>a[f]=ge.NULL),r=a}else{if(t.next&&(i=t.next),n=t.revert?n.concat({activePlayers:e.activePlayers,_activePlayersMoveLimit:e._activePlayersMoveLimit,_activePlayersNumMoves:e._activePlayersNumMoves}):[],t.currentPlayer!==void 0&&fe(r,o,e.currentPlayer,t.currentPlayer),t.others!==void 0)for(let a=0;a<e.playOrder.length;a++){const f=e.playOrder[a];f!==e.currentPlayer&&fe(r,o,f,t.others)}if(t.all!==void 0)for(let a=0;a<e.playOrder.length;a++){const f=e.playOrder[a];fe(r,o,f,t.all)}if(t.value)for(const a in t.value)fe(r,o,a,t.value[a]);if(t.moveLimit)for(const a in r)o[a]===void 0&&(o[a]=t.moveLimit)}Object.keys(r).length==0&&(r=null),Object.keys(o).length==0&&(o=null);const c={};for(const a in r)c[a]=0;return{...e,activePlayers:r,_activePlayersMoveLimit:o,_activePlayersNumMoves:c,_prevActivePlayers:n,_nextActivePlayers:i}}function Or(e){let{activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:i}=e;if(t&&Object.keys(t).length==0)if(e._nextActivePlayers)e=Pe(e,e._nextActivePlayers),{activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:i}=e;else if(i.length>0){const o=i.length-1;({activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r}=i[o]),i=i.slice(0,o)}else t=null,n=null;return{...e,activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:i}}function fe(e,t,n,r){(typeof r!="object"||r===ge.NULL)&&(r={stage:r}),r.stage!==void 0&&(e[n]=r.stage,r.moveLimit&&(t[n]=r.moveLimit))}function Fe(e,t){return e[t]+""}function wr(e,t){let{G:n,ctx:r}=e;const i=ee(e),o=t.order;let c=[...new Array(r.numPlayers)].map((p,y)=>y+"");o.playOrder!==void 0&&(c=o.playOrder(n,i));const a=o.first(n,i),f=typeof a;f!=="number"&&x(`invalid value returned by turn.order.first — expected number got ${f} “${a}”.`);const h=Fe(c,a);return r={...r,currentPlayer:h,playOrderPos:a,playOrder:c},r=Pe(r,t.activePlayers||{}),r}function Sr(e,t,n,r){const i=n.order;let{G:o,ctx:c}=e,a=c.playOrderPos,f=!1;if(r&&r!==!0)typeof r!="object"&&x(`invalid argument to endTurn: ${r}`),Object.keys(r).forEach(h=>{switch(h){case"remove":t=Fe(c.playOrder,a);break;case"next":a=c.playOrder.indexOf(r.next),t=r.next;break;default:x(`invalid argument to endTurn: ${h}`)}});else{const h=ee(e),p=i.next(o,h),y=typeof p;p!==void 0&&y!=="number"&&x(`invalid value returned by turn.order.next — expected number or undefined got ${y} “${p}”.`),p===void 0?f=!0:(a=p,t=Fe(c.playOrder,a))}return c={...c,playOrderPos:a,currentPlayer:t},{endPhase:f,ctx:c}}const _r={DEFAULT:{first:(e,t)=>t.turn===0?t.playOrderPos:(t.playOrderPos+1)%t.playOrder.length,next:(e,t)=>(t.playOrderPos+1)%t.playOrder.length},RESET:{first:()=>0,next:(e,t)=>(t.playOrderPos+1)%t.playOrder.length},CONTINUE:{first:(e,t)=>t.playOrderPos,next:(e,t)=>(t.playOrderPos+1)%t.playOrder.length},ONCE:{first:()=>0,next:(e,t)=>{if(t.playOrderPos<t.playOrder.length-1)return t.playOrderPos+1}},CUSTOM:e=>({playOrder:()=>e,first:()=>0,next:(t,n)=>(n.playOrderPos+1)%n.playOrder.length}),CUSTOM_FROM:e=>({playOrder:t=>t[e],first:()=>0,next:(t,n)=>(n.playOrderPos+1)%n.playOrder.length})},ge={NULL:null};var X={},ue={};Object.defineProperty(ue,"__esModule",{value:!0});ue.Pointer=void 0;function Er(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Ir(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}var Dr=function(){function e(t){t===void 0&&(t=[""]),this.tokens=t}return e.fromJSON=function(t){var n=t.split("/").map(Er);if(n[0]!=="")throw new Error("Invalid JSON Pointer: "+t);return new e(n)},e.prototype.toString=function(){return this.tokens.map(Ir).join("/")},e.prototype.evaluate=function(t){for(var n=null,r="",i=t,o=1,c=this.tokens.length;o<c;o++)n=i,r=this.tokens[o],!(r=="__proto__"||r=="constructor"||r=="prototype")&&(i=(n||{})[r]);return{parent:n,key:r,value:i}},e.prototype.get=function(t){return this.evaluate(t).value},e.prototype.set=function(t,n){for(var r=t,i=1,o=this.tokens.length-1,c=this.tokens[i];i<o;i++)r=(r||{})[c];r&&(r[this.tokens[this.tokens.length-1]]=n)},e.prototype.push=function(t){this.tokens.push(t)},e.prototype.add=function(t){var n=this.tokens.concat(String(t));return new e(n)},e}();ue.Pointer=Dr;var D={},st={};(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clone=e.objectType=e.hasOwnProperty=void 0,e.hasOwnProperty=Object.prototype.hasOwnProperty;function t(i){return i===void 0?"undefined":i===null?"null":Array.isArray(i)?"array":typeof i}e.objectType=t;function n(i){return i!=null&&typeof i=="object"}function r(i){if(!n(i))return i;if(i.constructor==Array){for(var o=i.length,c=new Array(o),a=0;a<o;a++)c[a]=r(i[a]);return c}if(i.constructor==Date){var f=new Date(+i);return f}var h={};for(var p in i)e.hasOwnProperty.call(i,p)&&(h[p]=r(i[p]));return h}e.clone=r})(st);var C={};Object.defineProperty(C,"__esModule",{value:!0});C.diffAny=C.diffObjects=C.diffArrays=C.intersection=C.subtract=C.isDestructive=void 0;var oe=st;function xr(e){var t=e.op;return t==="remove"||t==="replace"||t==="copy"||t==="move"}C.isDestructive=xr;function We(e,t){var n={};for(var r in e)oe.hasOwnProperty.call(e,r)&&e[r]!==void 0&&(n[r]=1);for(var i in t)oe.hasOwnProperty.call(t,i)&&t[i]!==void 0&&delete n[i];return Object.keys(n)}C.subtract=We;function Bt(e){for(var t=e.length,n={},r=0;r<t;r++){var i=e[r];for(var o in i)oe.hasOwnProperty.call(i,o)&&i[o]!==void 0&&(n[o]=(n[o]||0)+1)}for(var o in n)n[o]<t&&delete n[o];return Object.keys(n)}C.intersection=Bt;function Mr(e){return e.op==="add"}function Ar(e){return e.op==="remove"}function Ne(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function Jt(e,t,n,r){r===void 0&&(r=Oe);var i={"0,0":{operations:[],cost:0}};function o(p,y){var w=p+","+y,b=i[w];if(b===void 0){if(p>0&&y>0&&!r(e[p-1],t[y-1],n.add(String(p-1))).length)b=o(p-1,y-1);else{var O=[];if(p>0){var m=o(p-1,y),S={op:"remove",index:p-1};O.push(Ne(m,S))}if(y>0){var M=o(p,y-1),E={op:"add",index:p-1,value:t[y-1]};O.push(Ne(M,E))}if(p>0&&y>0){var A=o(p-1,y-1),z={op:"replace",index:p-1,original:e[p-1],value:t[y-1]};O.push(Ne(A,z))}var Q=O.sort(function(we,Se){return we.cost-Se.cost})[0];b=Q}i[w]=b}return b}var c=isNaN(e.length)||e.length<=0?0:e.length,a=isNaN(t.length)||t.length<=0?0:t.length,f=o(c,a).operations,h=f.reduce(function(p,y){var w=p[0],b=p[1];if(Mr(y)){var O=y.index+1+b,m=O<c+b?String(O):"-",S={op:y.op,path:n.add(m).toString(),value:y.value};return[w.concat(S),b+1]}else if(Ar(y)){var S={op:y.op,path:n.add(String(y.index+b)).toString()};return[w.concat(S),b-1]}else{var M=n.add(String(y.index+b)),E=r(y.original,y.value,M);return[w.concat.apply(w,E),b]}},[[],0])[0];return h}C.diffArrays=Jt;function Kt(e,t,n,r){r===void 0&&(r=Oe);var i=[];return We(e,t).forEach(function(o){i.push({op:"remove",path:n.add(o).toString()})}),We(t,e).forEach(function(o){i.push({op:"add",path:n.add(o).toString(),value:t[o]})}),Bt([e,t]).forEach(function(o){i.push.apply(i,r(e[o],t[o],n.add(o)))}),i}C.diffObjects=Kt;function Oe(e,t,n,r){if(r===void 0&&(r=Oe),e===t)return[];var i=oe.objectType(e),o=oe.objectType(t);return i=="array"&&o=="array"?Jt(e,t,n,r):i=="object"&&o=="object"?Kt(e,t,n,r):[{op:"replace",path:n.toString(),value:t}]}C.diffAny=Oe;var at=Et&&Et.__extends||function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(r[o]=i[o])},e(t,n)};return function(t,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(t,n);function r(){this.constructor=t}t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(D,"__esModule",{value:!0});D.apply=D.InvalidOperationError=D.test=D.copy=D.move=D.replace=D.remove=D.add=D.TestError=D.MissingError=void 0;var J=ue,Ht=st,Nr=C,V=function(e){at(t,e);function t(n){var r=e.call(this,"Value required at path: "+n)||this;return r.path=n,r.name="MissingError",r}return t}(Error);D.MissingError=V;var qt=function(e){at(t,e);function t(n,r){var i=e.call(this,"Test failed: "+n+" != "+r)||this;return i.actual=n,i.expected=r,i.name="TestError",i}return t}(Error);D.TestError=qt;function ut(e,t,n){if(Array.isArray(e))if(t=="-")e.push(n);else{var r=parseInt(t,10);e.splice(r,0,n)}else e[t]=n}function Xt(e,t){if(Array.isArray(e)){var n=parseInt(t,10);e.splice(n,1)}else delete e[t]}function Yt(e,t){var n=J.Pointer.fromJSON(t.path).evaluate(e);return n.parent===void 0?new V(t.path):(ut(n.parent,n.key,Ht.clone(t.value)),null)}D.add=Yt;function Qt(e,t){var n=J.Pointer.fromJSON(t.path).evaluate(e);return n.value===void 0?new V(t.path):(Xt(n.parent,n.key),null)}D.remove=Qt;function Zt(e,t){var n=J.Pointer.fromJSON(t.path).evaluate(e);if(n.parent===null)return new V(t.path);if(Array.isArray(n.parent)){if(parseInt(n.key,10)>=n.parent.length)return new V(t.path)}else if(n.value===void 0)return new V(t.path);return n.parent[n.key]=t.value,null}D.replace=Zt;function en(e,t){var n=J.Pointer.fromJSON(t.from).evaluate(e);if(n.value===void 0)return new V(t.from);var r=J.Pointer.fromJSON(t.path).evaluate(e);return r.parent===void 0?new V(t.path):(Xt(n.parent,n.key),ut(r.parent,r.key,n.value),null)}D.move=en;function tn(e,t){var n=J.Pointer.fromJSON(t.from).evaluate(e);if(n.value===void 0)return new V(t.from);var r=J.Pointer.fromJSON(t.path).evaluate(e);return r.parent===void 0?new V(t.path):(ut(r.parent,r.key,Ht.clone(n.value)),null)}D.copy=tn;function nn(e,t){var n=J.Pointer.fromJSON(t.path).evaluate(e);return Nr.diffAny(n.value,t.value,new J.Pointer).length?new qt(n.value,t.value):null}D.test=nn;var rn=function(e){at(t,e);function t(n){var r=e.call(this,"Invalid operation: "+n.op)||this;return r.operation=n,r.name="InvalidOperationError",r}return t}(Error);D.InvalidOperationError=rn;function Gr(e,t){switch(t.op){case"add":return Yt(e,t);case"remove":return Qt(e,t);case"replace":return Zt(e,t);case"move":return en(e,t);case"copy":return tn(e,t);case"test":return nn(e,t)}return new rn(t)}D.apply=Gr;Object.defineProperty(X,"__esModule",{value:!0});X.createTests=X.createPatch=sn=X.applyPatch=void 0;var on=ue,Cr=D,ct=C;function jr(e,t){return t.map(function(n){return Cr.apply(e,n)})}var sn=X.applyPatch=jr;function Tr(e){function t(n,r,i){var o=e(n,r,i);return Array.isArray(o)?o:ct.diffAny(n,r,i,t)}return t}function Lr(e,t,n){var r=new on.Pointer;return(n?Tr(n):ct.diffAny)(e,t,r)}X.createPatch=Lr;function xt(e,t){var n=on.Pointer.fromJSON(t).evaluate(e);if(n!==void 0)return{op:"test",path:t,value:n.value}}function Ur(e,t){var n=new Array;return t.filter(ct.isDestructive).forEach(function(r){var i=xt(e,r.path);if(i&&n.push(i),"from"in r){var o=xt(e,r.from);o&&n.push(o)}}),n}X.createTests=Ur;function Rr({moves:e,phases:t,endIf:n,onEnd:r,turn:i,events:o,plugins:c}){e===void 0&&(e={}),o===void 0&&(o={}),c===void 0&&(c=[]),t===void 0&&(t={}),n||(n=()=>{}),r||(r=s=>s),i||(i={});const a={...t};""in a&&x("cannot specify phase with empty name"),a[""]={};const f={},h=new Set;let p=null;Object.keys(e).forEach(s=>h.add(s));const y=s=>{const u=zt(s,c);return l=>{const v=ee(l);return u(l.G,v)}},w=s=>u=>{const l=ee(u);return s(u.G,l)},b={onEnd:y(r),endIf:w(n)};for(const s in a){const u=a[s];if(u.start===!0&&(p=s),u.moves!==void 0)for(const l of Object.keys(u.moves))f[s+"."+l]=u.moves[l],h.add(l);u.endIf===void 0&&(u.endIf=()=>{}),u.onBegin===void 0&&(u.onBegin=l=>l),u.onEnd===void 0&&(u.onEnd=l=>l),u.turn===void 0&&(u.turn=i),u.turn.order===void 0&&(u.turn.order=_r.DEFAULT),u.turn.onBegin===void 0&&(u.turn.onBegin=l=>l),u.turn.onEnd===void 0&&(u.turn.onEnd=l=>l),u.turn.endIf===void 0&&(u.turn.endIf=()=>!1),u.turn.onMove===void 0&&(u.turn.onMove=l=>l),u.turn.stages===void 0&&(u.turn.stages={});for(const l in u.turn.stages){const g=u.turn.stages[l].moves||{};for(const d of Object.keys(g)){const P=s+"."+l+"."+d;f[P]=g[d],h.add(d)}}u.wrapped={onBegin:y(u.onBegin),onEnd:y(u.onEnd),endIf:w(u.endIf)},u.turn.wrapped={onMove:y(u.turn.onMove),onBegin:y(u.turn.onBegin),onEnd:y(u.turn.onEnd),endIf:w(u.turn.endIf)}}function O(s){return s.phase?a[s.phase]:a[""]}function m(s){return s}function S(s,u){const l=new Set,v=new Set;for(let g=0;g<u.length;g++){const{fn:d,arg:P,...I}=u[g];if(d===H){v.clear();const K=s.ctx.phase;if(l.has(K)){const N={...s.ctx,phase:null};return{...s,ctx:N}}l.add(K)}const _=[];if(s=d(s,{...I,arg:P,next:_}),d===_e)break;const T=Se(s);if(T){u.push({fn:_e,arg:T,turn:s.ctx.turn,phase:s.ctx.phase,automatic:!0});continue}const F=ln(s);if(F){u.push({fn:H,arg:F,turn:s.ctx.turn,phase:s.ctx.phase,automatic:!0});continue}if(d===m){const K=fn(s);if(K){u.push({fn:ce,arg:K,turn:s.ctx.turn,phase:s.ctx.phase,automatic:!0});continue}}u.push(..._)}return s}function M(s,{next:u}){return u.push({fn:E}),s}function E(s,{next:u}){let{G:l,ctx:v}=s;return l=O(v).wrapped.onBegin(s),u.push({fn:A}),{...s,G:l,ctx:v}}function A(s,{currentPlayer:u}){let{G:l,ctx:v}=s;const g=O(v);u?(v={...v,currentPlayer:u},g.turn.activePlayers&&(v=Pe(v,g.turn.activePlayers))):v=wr(s,g.turn);const d=v.turn+1;return v={...v,turn:d,numMoves:0,_prevActivePlayers:[]},l=g.turn.wrapped.onBegin({...s,G:l,ctx:v}),{...s,G:l,ctx:v,_undo:[],_redo:[]}}function z(s,{arg:u,next:l,phase:v}){const g=O({phase:v});let{ctx:d}=s;if(u&&u.next)if(u.next in a)d={...d,phase:u.next};else return x("invalid phase: "+u.next),s;else g.next!==void 0?d={...d,phase:g.next}:d={...d,phase:null};return s={...s,ctx:d},l.push({fn:E}),s}function Q(s,{arg:u,currentPlayer:l,next:v}){let{G:g,ctx:d}=s;const P=O(d),{endPhase:I,ctx:_}=Sr(s,l,P.turn,u);return d=_,s={...s,G:g,ctx:d},I?v.push({fn:H,turn:d.turn,phase:d.phase}):v.push({fn:A,currentPlayer:d.currentPlayer}),s}function we(s,{arg:u,playerID:l}){(typeof u=="string"||u===ge.NULL)&&(u={stage:u});let{ctx:v}=s,{activePlayers:g,_activePlayersMoveLimit:d,_activePlayersNumMoves:P}=v;return u.stage!==void 0&&(g===null&&(g={}),g[l]=u.stage,P[l]=0,u.moveLimit&&(d===null&&(d={}),d[l]=u.moveLimit)),v={...v,activePlayers:g,_activePlayersMoveLimit:d,_activePlayersNumMoves:P},{...s,ctx:v}}function Se(s){return b.endIf(s)}function ln(s){return O(s.ctx).wrapped.endIf(s)}function fn(s){const u=O(s.ctx),l=s.ctx.numMoves||0;return u.turn.moveLimit&&l>=u.turn.moveLimit?!0:u.turn.wrapped.endIf(s)}function _e(s,{arg:u,phase:l}){s=H(s,{phase:l}),u===void 0&&(u=!0),s={...s,ctx:{...s.ctx,gameover:u}};const v=b.onEnd(s);return{...s,G:v}}function H(s,{arg:u,next:l,turn:v,automatic:g}){s=ce(s,{turn:v,force:!0,automatic:!0});let d=s.G,P=s.ctx;if(l&&l.push({fn:z,arg:u,phase:P.phase}),P.phase===null)return s;d=O(P).wrapped.onEnd(s),P={...P,phase:null};const T={action:pe("endPhase",u),_stateID:s._stateID,turn:s.ctx.turn,phase:s.ctx.phase};g&&(T.automatic=!0);const F=[...s.deltalog||[],T];return{...s,G:d,ctx:P,deltalog:F}}function ce(s,{arg:u,next:l,turn:v,force:g,automatic:d,playerID:P}){if(v!==s.ctx.turn)return s;let{G:I,ctx:_}=s;const T=O(_),F=_.numMoves||0;if(!g&&T.turn.moveLimit&&F<T.turn.moveLimit)return`${T.turn.moveLimit}`,s;if(I=T.turn.wrapped.onEnd(s),l&&l.push({fn:Q,arg:u,currentPlayer:_.currentPlayer}),_={..._,activePlayers:null},u&&u.remove){P=P||_.currentPlayer;const Ie=_.playOrder.filter(Sn=>Sn!=P),wn=_.playOrderPos>Ie.length-1?0:_.playOrderPos;if(_={..._,playOrder:Ie,playOrderPos:wn},Ie.length===0)return l.push({fn:H,turn:_.turn,phase:_.phase}),s}const N={action:pe("endTurn",u),_stateID:s._stateID,turn:s.ctx.turn,phase:s.ctx.phase};d&&(N.automatic=!0);const k=[...s.deltalog||[],N];return{...s,G:I,ctx:_,deltalog:k,_undo:[],_redo:[]}}function Ee(s,{arg:u,next:l,automatic:v,playerID:g}){g=g||s.ctx.currentPlayer;let{ctx:d}=s,{activePlayers:P,_activePlayersMoveLimit:I}=d;const _=P!==null&&g in P;if(!u&&_){const k=O(d).turn.stages[P[g]];k&&k.next&&(u=k.next)}if(l&&u!==void 0&&l.push({fn:we,arg:u,playerID:g}),!_)return s;P=Object.keys(P).filter(N=>N!==g).reduce((N,k)=>(N[k]=P[k],N),{}),I&&(I=Object.keys(I).filter(N=>N!==g).reduce((N,k)=>(N[k]=I[k],N),{})),d=Or({...d,activePlayers:P,_activePlayersMoveLimit:I});const F={action:pe("endStage",u),_stateID:s._stateID,turn:s.ctx.turn,phase:s.ctx.phase};v&&(F.automatic=!0);const K=[...s.deltalog||[],F];return{...s,ctx:d,deltalog:K}}function dt(s,u,l){const v=O(s),g=v.turn.stages,{activePlayers:d}=s;if(d&&d[l]!==void 0&&d[l]!==ge.NULL&&g[d[l]]!==void 0&&g[d[l]].moves!==void 0){const I=g[d[l]].moves;if(u in I)return I[u]}else if(v.moves){if(u in v.moves)return v.moves[u]}else if(u in e)return e[u];return null}function dn(s,u){const l=O(s.ctx),v=dt(s.ctx,u.type,u.playerID),g=!v||typeof v=="function"||v.noLimit!==!0,{ctx:d}=s,{_activePlayersNumMoves:P}=d,{playerID:I}=u;let _=s.ctx.numMoves;g&&(I==s.ctx.currentPlayer&&_++,d.activePlayers&&P[I]++),s={...s,ctx:{...d,numMoves:_,_activePlayersNumMoves:P}},d._activePlayersMoveLimit&&P[I]>=d._activePlayersMoveLimit[I]&&(s=Ee(s,{playerID:I,automatic:!0}));const T=l.turn.wrapped.onMove(s);return s={...s,G:T},S(s,[{fn:m}])}function pn(s,u,l){return S(s,[{fn:Ee,arg:l,playerID:u}])}function hn(s,u){return S(s,[{fn:Ee,playerID:u}])}function vn(s,u,l){return S(s,[{fn:H,phase:s.ctx.phase,turn:s.ctx.turn,arg:{next:l}}])}function yn(s){return S(s,[{fn:H,phase:s.ctx.phase,turn:s.ctx.turn}])}function mn(s,u,l){return S(s,[{fn:ce,turn:s.ctx.turn,phase:s.ctx.phase,arg:l}])}function gn(s,u,l){return S(s,[{fn:ce,turn:s.ctx.turn,phase:s.ctx.phase,force:!0,arg:l}])}function bn(s,u,l){return S(s,[{fn:_e,turn:s.ctx.turn,phase:s.ctx.phase,arg:l}])}const le={endStage:hn,setStage:pn,endTurn:mn,pass:gn,endPhase:yn,setPhase:vn,endGame:bn,setActivePlayers:Pr},B=[];o.endTurn!==!1&&B.push("endTurn"),o.pass!==!1&&B.push("pass"),o.endPhase!==!1&&B.push("endPhase"),o.setPhase!==!1&&B.push("setPhase"),o.endGame!==!1&&B.push("endGame"),o.setActivePlayers!==!1&&B.push("setActivePlayers"),o.endStage!==!1&&B.push("endStage"),o.setStage!==!1&&B.push("setStage");function Pn(s,u){const{type:l,playerID:v,args:g}=u.payload;if(Object.prototype.hasOwnProperty.call(le,l)){const d=[s,v].concat(g);return le[l].apply({},d)}return s}function On(s,u,l){return u.activePlayers?l in u.activePlayers:u.currentPlayer===l}return{ctx:s=>({numPlayers:s,turn:0,currentPlayer:"0",playOrder:[...new Array(s)].map((u,l)=>l+""),playOrderPos:0,phase:p,activePlayers:null}),init:s=>S(s,[{fn:M}]),isPlayerActive:On,eventHandlers:le,eventNames:Object.keys(le),enabledEventNames:B,moveMap:f,moveNames:[...h.values()],processMove:dn,processEvent:Pn,getMove:dt}}function kr(e){return e.processMove!==void 0}function lt(e){if(kr(e))return e;if(e.name===void 0&&(e.name="default"),e.deltaState===void 0&&(e.deltaState=!1),e.disableUndo===void 0&&(e.disableUndo=!1),e.setup===void 0&&(e.setup=()=>({})),e.moves===void 0&&(e.moves={}),e.playerView===void 0&&(e.playerView=n=>n),e.plugins===void 0&&(e.plugins=[]),e.plugins.forEach(n=>{if(n.name===void 0)throw new Error("Plugin missing name attribute");if(n.name.includes(" "))throw new Error(n.name+": Plugin name must not include spaces")}),e.name.includes(" "))throw new Error(e.name+": Game name must not include spaces");const t=Rr(e);return{...e,flow:t,moveNames:t.moveNames,pluginNames:e.plugins.map(n=>n.name),processMove:(n,r)=>{let i=t.getMove(n.ctx,r.type,r.playerID);if($r(i)&&(i=i.move),i instanceof Function){const o=zt(i,e.plugins),c={...ee(n),playerID:r.playerID};let a=[];return r.args!==void 0&&(a=a.concat(r.args)),o(n.G,c,...a)}return x(`invalid move object: ${r.type}`),n.G}}}function $r(e){return e instanceof Object&&e.move!==void 0}var Ve;(function(e){e.UnauthorizedAction="update/unauthorized_action",e.MatchNotFound="update/match_not_found",e.PatchFailed="update/patch_failed"})(Ve||(Ve={}));var G;(function(e){e.StaleStateId="action/stale_state_id",e.UnavailableMove="action/unavailable_move",e.InvalidMove="action/invalid_move",e.InactivePlayer="action/inactive_player",e.GameOver="action/gameover",e.ActionDisabled="action/action_disabled",e.ActionInvalid="action/action_invalid"})(G||(G={}));const de=e=>e.payload.playerID!==null&&e.payload.playerID!==void 0,Fr=(e,t,n)=>{function r(o){return o.undoable!==void 0}function i(o){return o instanceof Function}return r(n)?i(n.undoable)?n.undoable(e,t):n.undoable:!0};function Mt(e,t){if(t.game.disableUndo)return e;const n={G:e.G,ctx:e.ctx,plugins:e.plugins,playerID:t.action.payload.playerID||e.ctx.currentPlayer};return t.action.type==="MAKE_MOVE"&&(n.moveType=t.action.payload.type),{...e,_undo:[...e._undo,n],_redo:[]}}function Ge(e,t,n){const r={action:t,_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase},i=e.plugins.log.data.metadata;return i!==void 0&&(r.metadata=i),typeof n=="object"&&n.redact===!0&&(r.redact=!0),{...e,deltalog:[r]}}function an(e){if(!e)return[null,void 0];const{transients:t,...n}=e;return[n,t]}function j(e,t,n){return{...e,transients:{error:{type:t,payload:n}}}}const Wr=e=>t=>n=>{const r=t(n);switch(n.type){case ot:return r;default:{const[,i]=an(e.getState());return typeof i<"u"?(e.dispatch(Ft()),{...r,transients:i}):r}}};function Vr({game:e,isClient:t}){return e=lt(e),(n=null,r)=>{let[i]=an(n);switch(r.type){case ot:return i;case be:{if(i={...i,deltalog:[]},t)return i;if(i.ctx.gameover!==void 0)return x("cannot call event after game end"),j(i,G.GameOver);if(de(r)&&!e.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return x(`disallowed event: ${r.payload.type}`),j(i,G.InactivePlayer);i=$e(i,{game:e,isClient:!1,playerID:r.payload.playerID});let o=e.flow.processEvent(i,r);return o=he(o,{game:e,isClient:!1}),o=Mt(o,{game:e,action:r}),{...o,_stateID:i._stateID+1}}case Qe:{i={...i,deltalog:[]};const o=e.flow.getMove(i.ctx,r.payload.type,r.payload.playerID||i.ctx.currentPlayer);if(o===null)return x(`disallowed move: ${r.payload.type}`),j(i,G.UnavailableMove);if(t&&o.client===!1)return i;if(i.ctx.gameover!==void 0)return x("cannot make move after game end"),j(i,G.GameOver);if(de(r)&&!e.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return x(`disallowed move: ${r.payload.type}`),j(i,G.InactivePlayer);i=$e(i,{game:e,isClient:t,playerID:r.payload.playerID});const c=e.processMove(i,r.payload);if(c===ke)return x(`invalid move: ${r.payload.type} args: ${r.payload.args}`),j(i,G.InvalidMove);const a={...i,G:c};return t&&mr(a,{game:e})?i:(i=a,t?(i=he(i,{game:e,isClient:!0}),{...i,_stateID:i._stateID+1}):(i=Ge(i,r,o),i=e.flow.processMove(i,r.payload),i=he(i,{game:e}),i=Mt(i,{game:e,action:r}),{...i,_stateID:i._stateID+1}))}case et:case rt:case tt:return r.state;case nt:{if(i={...i,deltalog:[]},e.disableUndo)return x("Undo is not enabled"),j(i,G.ActionDisabled);const{_undo:o,_redo:c}=i;if(o.length<2)return x("No moves to undo"),j(i,G.ActionInvalid);const a=o[o.length-1],f=o[o.length-2];if(de(r)&&r.payload.playerID!==a.playerID)return x("Cannot undo other players' moves"),j(i,G.ActionInvalid);if(a.moveType){const h=e.flow.getMove(f.ctx,a.moveType,a.playerID);if(!Fr(i.G,i.ctx,h))return x("Move cannot be undone"),j(i,G.ActionInvalid)}return i=Ge(i,r),{...i,G:f.G,ctx:f.ctx,plugins:f.plugins,_stateID:i._stateID+1,_undo:o.slice(0,-1),_redo:[a,...c]}}case Ze:{if(i={...i,deltalog:[]},e.disableUndo)return x("Redo is not enabled"),j(i,G.ActionDisabled);const{_undo:o,_redo:c}=i;if(c.length==0)return x("No moves to redo"),j(i,G.ActionInvalid);const a=c[0];return de(r)&&r.payload.playerID!==a.playerID?(x("Cannot redo other players' moves"),j(i,G.ActionInvalid)):(i=Ge(i,r),{...i,G:a.G,ctx:a.ctx,plugins:a.plugins,_stateID:i._stateID+1,_undo:[...o,a],_redo:c.slice(1)})}case Lt:return vr(i,r,{game:e});case it:{const o=i,c=JSON.parse(JSON.stringify(o)),a=sn(c,r.patch);return a.some(h=>h!==null)?(x(`Patch ${JSON.stringify(r.patch)} apply failed`),j(o,Ve.PatchFailed,a)):c}default:return i}}}function se(e){"@babel/helpers - typeof";return se=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},se(e)}function zr(e,t){if(se(e)!=="object"||e===null)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t||"default");if(se(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function Br(e){var t=zr(e,"string");return se(t)==="symbol"?t:String(t)}function Jr(e,t,n){return t=Br(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function At(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Nt(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?At(Object(n),!0).forEach(function(r){Jr(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):At(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function L(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var Gt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),Ce=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ct={INIT:"@@redux/INIT"+Ce(),REPLACE:"@@redux/REPLACE"+Ce(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Ce()}};function Kr(e){if(typeof e!="object"||e===null)return!1;for(var t=e;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function un(e,t,n){var r;if(typeof t=="function"&&typeof n=="function"||typeof n=="function"&&typeof arguments[3]=="function")throw new Error(L(0));if(typeof t=="function"&&typeof n>"u"&&(n=t,t=void 0),typeof n<"u"){if(typeof n!="function")throw new Error(L(1));return n(un)(e,t)}if(typeof e!="function")throw new Error(L(2));var i=e,o=t,c=[],a=c,f=!1;function h(){a===c&&(a=c.slice())}function p(){if(f)throw new Error(L(3));return o}function y(m){if(typeof m!="function")throw new Error(L(4));if(f)throw new Error(L(5));var S=!0;return h(),a.push(m),function(){if(S){if(f)throw new Error(L(6));S=!1,h();var E=a.indexOf(m);a.splice(E,1),c=null}}}function w(m){if(!Kr(m))throw new Error(L(7));if(typeof m.type>"u")throw new Error(L(8));if(f)throw new Error(L(9));try{f=!0,o=i(o,m)}finally{f=!1}for(var S=c=a,M=0;M<S.length;M++){var E=S[M];E()}return m}function b(m){if(typeof m!="function")throw new Error(L(10));i=m,w({type:Ct.REPLACE})}function O(){var m,S=y;return m={subscribe:function(E){if(typeof E!="object"||E===null)throw new Error(L(11));function A(){E.next&&E.next(p())}A();var z=S(A);return{unsubscribe:z}}},m[Gt]=function(){return this},m}return w({type:Ct.INIT}),r={dispatch:w,subscribe:y,getState:p,replaceReducer:b},r[Gt]=O,r}function cn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.length===0?function(r){return r}:t.length===1?t[0]:t.reduce(function(r,i){return function(){return r(i.apply(void 0,arguments))}})}function Hr(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(r){return function(){var i=r.apply(void 0,arguments),o=function(){throw new Error(L(15))},c={getState:i.getState,dispatch:function(){return o.apply(void 0,arguments)}},a=t.map(function(f){return f(c)});return o=cn.apply(void 0,a)(i.dispatch),Nt(Nt({},i),{},{dispatch:o})}}}function qr({game:e,numPlayers:t,setupData:n}){e=lt(e),t||(t=2);const r=e.flow.ctx(t);let i={G:{},ctx:r,plugins:{}};i=yr(i,{game:e}),i=$e(i,{game:e,playerID:void 0});const o=ee(i);i.G=e.setup(o,n);let c={...i,_undo:[],_redo:[],_stateID:0};return c=e.flow.init(c),c=he(c,{game:e}),e.disableUndo||(c._undo=[{G:c.G,ctx:c.ctx,plugins:c.plugins}]),c}class Xr{constructor({store:t,gameName:n,playerID:r,matchID:i,credentials:o,numPlayers:c}){this.store=t,this.gameName=n||"default",this.playerID=r||null,this.matchID=i||"default",this.credentials=o,this.numPlayers=c||2}}class Yr extends Xr{connect(){}disconnect(){}onAction(){}onChatMessage(){}subscribe(){}subscribeChatMessage(){}subscribeMatchData(){}updateCredentials(){}updateMatchID(){}updatePlayerID(){}}const Qr=e=>new Yr(e);class Zr{constructor(){this.debugPanel=null,this.currentClient=null,this.clients=new Map,this.subscribers=new Map}register(t){this.clients.set(t,t),this.mountDebug(t),this.notifySubscribers()}unregister(t){if(this.clients.delete(t),this.currentClient===t){this.unmountDebug();for(const[n]of this.clients){if(this.debugPanel)break;this.mountDebug(n)}}this.notifySubscribers()}subscribe(t){const n=Symbol();return this.subscribers.set(n,t),t(this.getState()),()=>{this.subscribers.delete(n)}}switchPlayerID(t){if(this.currentClient.multiplayer){for(const[n]of this.clients)if(n.playerID===t&&n.debugOpt!==!1&&n.multiplayer===this.currentClient.multiplayer){this.switchToClient(n);return}}this.currentClient.updatePlayerID(t),this.notifySubscribers()}switchToClient(t){t!==this.currentClient&&(this.unmountDebug(),this.mountDebug(t),this.notifySubscribers())}notifySubscribers(){const t=this.getState();this.subscribers.forEach(n=>{n(t)})}getState(){return{client:this.currentClient,debuggableClients:this.getDebuggableClients()}}getDebuggableClients(){return[...this.clients.values()].filter(t=>t.debugOpt!==!1)}mountDebug(t){if(t.debugOpt===!1||this.debugPanel!==null||typeof document>"u")return;let n,r=document.body;t.debugOpt&&t.debugOpt!==!0&&(n=t.debugOpt.impl||n,r=t.debugOpt.target||r),n&&(this.currentClient=t,this.debugPanel=new n({target:r,props:{clientManager:this}}))}unmountDebug(){this.debugPanel.$destroy(),this.debugPanel=null,this.currentClient=null}}const ei=new Zr;function ze(e,t,n){return!n&&e==null&&(e=t.getState().ctx.currentPlayer),e}function ft(e,t,n,r,i,o){return t.reduce((c,a)=>(c[a]=function(...f){n.dispatch(sr[e](a,f,ze(r,n,o),i))},c),{})}const ti=ft.bind(null,"makeMove"),ni=ft.bind(null,"gameEvent"),ri=ft.bind(null,"plugin");class ii{constructor({game:t,debug:n,numPlayers:r,multiplayer:i,matchID:o,playerID:c,credentials:a,enhancer:f}){this.game=lt(t),this.playerID=c,this.matchID=o,this.credentials=a,this.multiplayer=i,this.debugOpt=n,this.manager=ei,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=Vr({game:this.game,isClient:i!==void 0}),this.initialState=null,i||(this.initialState=qr({game:this.game,numPlayers:r})),this.reset=()=>{this.store.dispatch(Rt(this.initialState))},this.undo=()=>{const b=kt(ze(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(b)},this.redo=()=>{const b=$t(ze(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(b)},this.log=[];const w=Hr(Wr,()=>b=>O=>{const m=b(O);return this.notifySubscribers(),m},b=>O=>m=>{const S=b.getState(),M=O(m);return"clientOnly"in m||this.transport.onAction(S,m),M},b=>O=>m=>{const S=O(m),M=b.getState();switch(m.type){case Qe:case be:case nt:case Ze:{const E=M.deltalog;this.log=[...this.log,...E];break}case et:{this.log=[];break}case it:case rt:{let E=-1;this.log.length>0&&(E=this.log[this.log.length-1]._stateID);let A=m.deltalog||[];A=A.filter(z=>z._stateID>E),this.log=[...this.log,...A];break}case tt:{this.initialState=m.initialState,this.log=m.log||[];break}}return S});f=f!==void 0?cn(w,f):w,this.store=un(this.reducer,this.initialState,f),i||(i=Qr),this.transport=i({gameKey:t,game:this.game,store:this.store,matchID:o,playerID:c,credentials:a,gameName:this.game.name,numPlayers:r}),this.createDispatchers(),this.transport.subscribeMatchData(b=>{this.matchData=b,this.notifySubscribers()}),this.chatMessages=[],this.sendChatMessage=b=>{this.transport.onChatMessage(this.matchID,{id:kn(7),sender:this.playerID,payload:b})},this.transport.subscribeChatMessage(b=>{this.chatMessages=[...this.chatMessages,b],this.notifySubscribers()})}notifySubscribers(){Object.values(this.subscribers).forEach(t=>t(this.getState()))}overrideGameState(t){this.gameStateOverride=t,this.notifySubscribers()}start(){this.transport.connect(),this._running=!0,this.manager.register(this)}stop(){this.transport.disconnect(),this._running=!1,this.manager.unregister(this)}subscribe(t){const n=Object.keys(this.subscribers).length;return this.subscribers[n]=t,this.transport.subscribe(()=>this.notifySubscribers()),(this._running||!this.multiplayer)&&t(this.getState()),()=>{delete this.subscribers[n]}}getInitialState(){return this.initialState}getState(){let t=this.store.getState();if(this.gameStateOverride!==null&&(t=this.gameStateOverride),t===null)return t;let n=!0;const r=this.game.flow.isPlayerActive(t.G,t.ctx,this.playerID);return this.multiplayer&&!r&&(n=!1),!this.multiplayer&&this.playerID!==null&&this.playerID!==void 0&&!r&&(n=!1),t.ctx.gameover!==void 0&&(n=!1),this.multiplayer||(t={...t,G:this.game.playerView(t.G,t.ctx,this.playerID),plugins:gr(t,this)}),{...t,log:this.log,isActive:n,isConnected:this.transport.isConnected}}createDispatchers(){this.moves=ti(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=ni(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=ri(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}updatePlayerID(t){this.playerID=t,this.createDispatchers(),this.transport.updatePlayerID(t),this.notifySubscribers()}updateMatchID(t){this.matchID=t,this.createDispatchers(),this.transport.updateMatchID(t),this.notifySubscribers()}updateCredentials(t){this.credentials=t,this.createDispatchers(),this.transport.updateCredentials(t),this.notifySubscribers()}}function oi(e){return new ii(e)}function si(e){let t,n,r="My Board Game",i,o,c;return o=new e[0]({}),{c(){t=pt("main"),n=pt("h1"),n.textContent=r,i=xn(),Mn(o.$$.fragment)},l(a){t=ht(a,"MAIN",{});var f=An(t);n=ht(f,"H1",{"data-svelte-h":!0}),Nn(n)!=="svelte-8n12i"&&(n.textContent=r),i=Gn(f),Cn(o.$$.fragment,f),f.forEach(vt)},m(a,f){jn(a,t,f),yt(t,n),yt(t,i),Tn(o,t,null),c=!0},p:En,i(a){c||(Ln(o.$$.fragment,a),c=!0)},o(a){Un(o.$$.fragment,a),c=!1},d(a){a&&vt(t),Rn(o)}}}function ai(e){return[oi({game:MyGame,board:MyBoardComponent,debug:!0})]}class li extends In{constructor(t){super(),Dn(this,t,ai,si,_n,{})}}export{li as component};
